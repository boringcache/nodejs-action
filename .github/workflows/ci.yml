name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - run: npm install
      - run: npm run build
      - run: npm test

  test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - run: npm install
      - run: npm run build

      - name: Test action
        uses: ./
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        with:
          workspace: boringcache/actions

      - run: node --version
      - run: npm --version

  test-turbo-remote:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - run: npm install
      - run: npm run build

      - name: Setup Node.js with Turbo remote cache
        uses: ./
        env:
          BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}
        with:
          workspace: boringcache/actions
          turbo-remote-cache: 'true'

      - name: Verify Turbo env vars
        run: |
          set -euo pipefail
          echo "TURBO_API=$TURBO_API"
          echo "TURBO_TOKEN=$TURBO_TOKEN"
          [[ -n "$TURBO_API" ]] || { echo "TURBO_API not set"; exit 1; }
          [[ -n "$TURBO_TOKEN" ]] || { echo "TURBO_TOKEN not set"; exit 1; }

      - name: Test Turbo remote cache API via proxy
        run: |
          set -euo pipefail

          mkdir -p /tmp/turbo-e2e

          run_http() {
            local expected_status="$1"
            local output_path="$2"
            shift 2
            local status
            status=$(curl -sS -o "${output_path}" -w "%{http_code}" "$@")
            if [[ "${status}" != "${expected_status}" ]]; then
              echo "unexpected status: expected ${expected_status}, got ${status}"
              echo "curl args: $*"
              if [[ -f "${output_path}" ]]; then
                echo "response body:"
                cat "${output_path}"
              fi
              echo "=== proxy logs ==="
              cat /tmp/boringcache-proxy-*.log 2>/dev/null || echo "no proxy logs found"
              exit 1
            fi
          }

          TURBO_AUTH="authorization: Bearer ${TURBO_TOKEN}"
          TURBO_HASH=$(printf 'turbo-e2e-%s-%s-%s' "${GITHUB_RUN_ID}" "${GITHUB_RUN_ATTEMPT}" "$(date +%s)" | shasum -a 256 | awk '{print $1}')

          echo "=== Status check ==="
          run_http "200" /tmp/turbo-e2e/status.json -H "${TURBO_AUTH}" "${TURBO_API}/v8/artifacts/status"
          cat /tmp/turbo-e2e/status.json
          grep -q '"status":"enabled"' /tmp/turbo-e2e/status.json

          echo "=== PUT artifact ==="
          printf 'turbo-e2e-payload-%s\n' "${TURBO_HASH}" > /tmp/turbo-e2e/artifact.bin
          run_http "202" /tmp/turbo-e2e/put.json -X PUT -H "${TURBO_AUTH}" --data-binary @/tmp/turbo-e2e/artifact.bin "${TURBO_API}/v8/artifacts/${TURBO_HASH}"
          cat /tmp/turbo-e2e/put.json
          grep -q '"urls"' /tmp/turbo-e2e/put.json

          echo "=== GET artifact ==="
          run_http "200" /tmp/turbo-e2e/artifact-get.bin -H "${TURBO_AUTH}" "${TURBO_API}/v8/artifacts/${TURBO_HASH}"
          if ! cmp -s /tmp/turbo-e2e/artifact.bin /tmp/turbo-e2e/artifact-get.bin; then
            echo "Artifact round-trip mismatch"
            exit 1
          fi
          echo "Round-trip verified"

          echo "=== Query artifacts ==="
          run_http "200" /tmp/turbo-e2e/query.json -X POST -H "${TURBO_AUTH}" -H "content-type: application/json" -d "{\"hashes\":[\"${TURBO_HASH}\",\"deadbeef\"]}" "${TURBO_API}/v8/artifacts"
          cat /tmp/turbo-e2e/query.json
          grep -q "\"${TURBO_HASH}\"" /tmp/turbo-e2e/query.json
          grep -q '"size"' /tmp/turbo-e2e/query.json

          echo "=== Events ==="
          run_http "200" /tmp/turbo-e2e/events.txt -X POST -H "${TURBO_AUTH}" -H "content-type: application/json" -d "[{\"sessionId\":\"e2e\",\"source\":\"REMOTE\",\"event\":\"HIT\",\"hash\":\"${TURBO_HASH}\",\"duration\":7}]" "${TURBO_API}/v8/artifacts/events"

          echo "All Turbo remote cache API checks passed"

      - name: Build real Turborepo project
        run: |
          set -euo pipefail

          mkdir -p turbo-test/packages/ui/src turbo-test/packages/utils/src
          cd turbo-test

          NPM_VERSION=$(npm --version)
          cat > package.json << PKGJSON
          {
            "name": "turbo-test",
            "private": true,
            "packageManager": "npm@${NPM_VERSION}",
            "workspaces": ["packages/*"]
          }
          PKGJSON

          cat > turbo.json << 'TURBOJSON'
          {
            "$schema": "https://turbo.build/schema.json",
            "tasks": {
              "build": {
                "outputs": ["dist/**"]
              }
            }
          }
          TURBOJSON

          cat > packages/ui/package.json << 'UIPKG'
          {
            "name": "@turbo-test/ui",
            "version": "1.0.0",
            "scripts": { "build": "mkdir -p dist && echo 'built ui' > dist/index.js" }
          }
          UIPKG

          cat > packages/utils/package.json << 'UTILSPKG'
          {
            "name": "@turbo-test/utils",
            "version": "1.0.0",
            "scripts": { "build": "mkdir -p dist && echo 'built utils' > dist/index.js" }
          }
          UTILSPKG

          echo "export const Button = 'button';" > packages/ui/src/index.ts
          echo "export const add = (a, b) => a + b;" > packages/utils/src/index.ts

          npm install
          npx turbo@latest build --verbosity=2

          echo "=== First build done, running again to test cache ==="
          npx turbo@latest build --verbosity=2 2>&1 | tee /tmp/turbo-second-build.log

          if grep -q "cache hit" /tmp/turbo-second-build.log || grep -q "FULL TURBO" /tmp/turbo-second-build.log; then
            echo "Turbo remote cache hit confirmed"
          else
            echo "WARNING: No cache hit on second build (may be expected on first run)"
          fi

      - name: Upload proxy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: turbo-proxy-logs-${{ matrix.os }}
          path: |
            /tmp/boringcache-proxy-*.log
            /tmp/turbo-e2e/**
