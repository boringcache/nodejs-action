name: Node.js Setup Benchmark

on:
  workflow_dispatch:

env:
  BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}

jobs:
  # Baseline: actions/setup-node with actions/cache
  nodejs-actions-cache:
    name: "Baseline: actions/cache"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        run: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4
        with:
          repository: boringcache/action
          path: boringcache-action

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Cache node_modules (actions/cache)
        uses: actions/cache@v4
        with:
          path: boringcache-action/examples/nextjs_app/node_modules
          key: node-mods-benchmark-${{ runner.os }}-${{ hashFiles('boringcache-action/examples/nextjs_app/yarn.lock') }}
          restore-keys: node-mods-benchmark-${{ runner.os }}-

      - name: Yarn install
        run: |
          cd boringcache-action/examples/nextjs_app
          START_TIME=$(date +%s%N)
          yarn install --frozen-lockfile
          END_TIME=$(date +%s%N)
          DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "actions/cache yarn install - Run ${{ matrix.run }}: ${DURATION}ms"
          mkdir -p benchmark-results
          echo "${DURATION}" > benchmark-results/actions-cache-run${{ matrix.run }}.txt

      - uses: actions/upload-artifact@v4
        with:
          name: actions-cache-results-${{ matrix.run }}
          path: boringcache-action/examples/nextjs_app/benchmark-results/

  # Test: boringcache/nodejs action
  nodejs-boringcache:
    name: "Test: boringcache/nodejs"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        run: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: boringcache/action
          path: boringcache-action

      - name: Setup Node.js with boringcache
        uses: ./
        with:
          workspace: boringcache/actions
          node-version: '20'
          working-directory: boringcache-action/examples/nextjs_app

      - name: Enable Corepack
        run: corepack enable

      - name: Yarn install
        run: |
          cd boringcache-action/examples/nextjs_app
          START_TIME=$(date +%s%N)
          yarn install --frozen-lockfile
          END_TIME=$(date +%s%N)
          DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "boringcache/nodejs yarn install - Run ${{ matrix.run }}: ${DURATION}ms"
          mkdir -p benchmark-results
          echo "${DURATION}" > benchmark-results/boringcache-run${{ matrix.run }}.txt

      - uses: actions/upload-artifact@v4
        with:
          name: boringcache-results-${{ matrix.run }}
          path: boringcache-action/examples/nextjs_app/benchmark-results/

  benchmark-summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [nodejs-actions-cache, nodejs-boringcache]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-results-*"
          merge-multiple: true

      - name: Generate summary
        run: |
          echo "# Node.js Setup Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Yarn Install Times (Next.js app)" >> $GITHUB_STEP_SUMMARY
          echo "| Run | actions/setup-node + actions/cache | boringcache/nodejs | Improvement |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------------------------------|-------------------|-------------|" >> $GITHUB_STEP_SUMMARY

          for run in 1 2 3; do
            if [[ -f "actions-cache-run${run}.txt" && -f "boringcache-run${run}.txt" ]]; then
              a=$(cat "actions-cache-run${run}.txt")
              b=$(cat "boringcache-run${run}.txt")
              if [[ $b -gt 0 ]]; then
                imp=$(echo "scale=2; $a / $b" | bc -l)
              else
                imp="N/A"
              fi
              echo "| $run | ${a}ms | ${b}ms | ${imp}x |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $run | Missing | Missing | N/A |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY

          if [[ -f actions-cache-run1.txt && -f actions-cache-run2.txt && -f actions-cache-run3.txt && \
                -f boringcache-run1.txt && -f boringcache-run2.txt && -f boringcache-run3.txt ]]; then
            aa=$(( ($(cat actions-cache-run1.txt)+$(cat actions-cache-run2.txt)+$(cat actions-cache-run3.txt))/3 ))
            bb=$(( ($(cat boringcache-run1.txt)+$(cat boringcache-run2.txt)+$(cat boringcache-run3.txt))/3 ))
            if [[ $bb -gt 0 ]]; then
              imp=$(echo "scale=2; $aa / $bb" | bc -l)
            else
              imp="N/A"
            fi
            echo "- **actions/setup-node + actions/cache average**: ${aa}ms" >> $GITHUB_STEP_SUMMARY
            echo "- **boringcache/nodejs average**: ${bb}ms" >> $GITHUB_STEP_SUMMARY
            echo "- **Improvement**: ${imp}x" >> $GITHUB_STEP_SUMMARY
          fi
